---
title: MCP (Model Context Protocol) 技术详解与实战指南
publishedAt: 2026-01-29
summary: 关于Agent mcp的个人学习笔记总结
tags: ["agent", "mcp"]
---

# MCP (Model Context Protocol) 技术详解与实战指南

本文档[基于 Tina Huang 的视频教程整理](https://www.youtube.com/watch?v=kOhLoixrJXo)，旨在深入解析 Model Context Protocol (MCP) 的核心概念、架构原理及实战构建方法。

## 1. MCP 的定义与核心价值

### 1.1 什么是 MCP？
**MCP (Model Context Protocol)** 是由 Anthropic 提出的一种开放协议，用于标准化 LLM（大语言模型）应用程序与外部工具、数据源之间的连接方式。

### 1.2 为什么需要 MCP？（USB 接口类比）
视频中使用 **USB 接口** 作为核心类比来解释 MCP 的价值：
* **没有 USB 之前**：连接鼠标、打印机、摄像头等设备需要不同的专用接口和复杂的驱动程序。同理，在 MCP 出现之前，如果你想让 AI Agent 连接 Google Calendar、Slack 或本地文件，开发者需要为每一个工具编写特定的适配代码（API 集成）。这导致了开发碎片化和维护困难。
* **有了 USB 之后**：所有设备遵循统一标准，即插即用。MCP 就是 AI 时代的 "USB 接口"。它提供了一种通用标准，使得任何 AI 应用（Host）都可以轻松连接任何数据源或工具（Server），而无需针对每个工具进行定制开发。

---

## 2. MCP 的架构原理 (HCS 模型)

MCP 的运作依赖于三个核心组件的交互，简称 **HCS**：

1.  **Host (主机)**
    * **定义**：发起请求的 AI 应用程序。
    * **示例**：Claude Desktop App、IDE（如 Cursor, VS Code）、以及基于 AI 的 Agent 平台（如 n8n）。
    * **作用**：Host 类似于“电脑主机”，它需要接入各种外设（工具）。

2.  **Client (客户端)**
    * **定义**：驻留在 Host 内部的组件。
    * **作用**：它负责与 MCP Server 建立一对一的连接，并维护 MCP 协议的通信标准。Client 是 Host 与外界沟通的“翻译官”。

3.  **Server (服务器)**
    * **定义**：提供具体能力或数据的轻量级程序。
    * **作用**：它向 Client 暴露特定的功能。例如：
        * **Alpha Vantage Server**：提供股票市场数据。
        * **PostgreSQL Server**：提供数据库只读访问或查询功能。
        * **GitLab Server**：提供版本控制能力。

---

## 3. MCP Server 的三大要素 (TRP)

一个完整的 MCP Server 可以包含以下三种内容，简称 **TRP**：

### 3.1 Tools (工具)
* **定义**：Client 可以调用的**函数**或**可执行操作**。
* **功能**：允许模型执行具体的动作。
* **示例**：
    * 发送一封 Gmail 邮件。
    * 计算数学公式。
    * 在数据库中插入一条记录。
    * 查询股票实时价格。

### 3.2 Resources (资源)
* **定义**：Server 暴露的**只读数据**。
* **功能**：允许模型像读取文件一样读取数据，但不能修改。
* **示例**：
    * 读取系统日志文件。
    * 访问存储在本地的 Markdown 笔记。
    * 查看数据库中的历史记录。
    * **场景**：如果你需要 AI 分析过去一周的天气日志，这些日志就是作为“资源”提供给 AI 的，而不是通过反复调用“查询天气”的工具来获取。

### 3.3 Prompts (提示词模板)
* **定义**：预设的结构化提示词（Blueprints）。
* **功能**：帮助用户更高效地使用工具，无需手动编写复杂的 Prompt。
* **示例**：
    * **场景**：你想让 AI 总结会议记录并生成报告。
    * **做法**：Server 开发者可以内置一个名为 `analyze-meeting` 的 Prompt 模板。用户只需选择该模板，输入会议记录，Server 就会使用经过优化的 Prompt 指导 LLM 生成高质量报告。

---

## 4. 通信生命周期与传输机制

### 4.1 通信流程
MCP 的交互遵循标准的生命周期：
1.  **Initialization (初始化)**：Client 向 Server 发起握手，建立连接。
2.  **Message Exchange (消息交换)**：Client 请求使用工具或资源，Server 响应结果。
3.  **Termination (终止)**：断开连接。

### 4.2 Transport (传输层) 类型
Server 和 Client 之间的通信方式（Transport）主要分为两类：

* **本地运行 (Local - Stdio)**
    * **原理**：Host 和 Server 运行在同一台机器上。
    * **类比**：就像你在家里（Local）和朋友一起做饭，直接递纸条沟通。
    * **机制**：通过标准输入/输出（Standard IO）进行通信，简单高效。

* **远程运行 (Remote)**
    * **原理**：Server 运行在云端或其他服务器上。
    * **类比**：去餐厅吃饭，你需要通过服务员（网络协议）来传达需求。
    * **协议**：
        * **HTTP + SSE (Server-Sent Events)**：**有状态 (Stateful)** 连接。就像在餐厅点餐，服务员（Server）记得你是谁，记得你之前点了什么。
        * **HTTP (Stateless)**：**无状态** 连接。就像在快餐店，收银员不记得你上一单点了什么，每次都要重新说明。
    * **最佳实践**：推荐使用 **Streamable HTTP**，它能同时支持有状态和无状态的交互模式。

---

## 5. 实战演示 A：零代码构建 MCP Server (No-Code)

本节演示如何使用 **n8n** 构建一个无代码的 MCP Server，并将其连接到 **Claude Desktop**。

### 步骤 1：在 n8n 中构建 Workflow
1.  创建一个新的 n8n 工作流。
2.  添加 **MCP Server Trigger** 节点。
3.  添加工具节点（Tools）：
    * **Calculator**：简单的数学计算工具。
    * **Gmail**：配置 OAuth 凭证，设置操作为“发送邮件”。
    * **参数配置**：将收件人、主题、正文设置为“由模型决定（Model Defined）”，这样 AI 就可以动态填充这些信息。

### 步骤 2：获取连接端点
1.  保存并激活工作流。
2.  复制 n8n 生成的 **Production URL** (通常是 HTTP Streamable 地址)。

### 步骤 3：配置 Claude Desktop (作为 Host)
1.  打开 Claude Desktop App。
2.  进入 `Settings` -> `Developer` -> `Edit Config`。
3.  编辑配置文件（通常是 JSON 格式），添加你的 n8n Server 信息：
    ```json
    "mcpServers": {
      "n8n-server": {
        "command": "...", 
        "url": "YOUR_N8N_URL_HERE",
        "transport": "sse" 
      }
    }
    ```
    *(注：视频演示中使用的是 SSE/HTTP 配置方式，具体字段需参考最新的 Claude 文档)*

### 步骤 4：测试
* 在 Claude 中输入：“给 Tina 发送一封邮件，邀请她喝咖啡。”
* Claude 会识别意图，请求调用 n8n 的 Gmail 工具。
* 用户点击“Allow”后，邮件通过 n8n 自动发送。

---

## 6. 实战演示 B：代码构建 MCP Server (Code)

虽然 No-Code 很方便，但代码开发能解锁 MCP 的全部潜力（特别是 Resources 和 Prompts 功能，这些在 n8n 中可能受限）。本节以 **Google Sheets MCP Server** 为例。

### 核心功能展示
视频演示了一个基于 Python 的 Server，具备以下高级能力：

1.  **Tools (工具操作)**
    * `list_spreadsheets`: 列出所有可用的表格。
    * `read_sheet` / `append_sheet`: 读写表格内容。
    * **演示**：AI 成功列出了账户下的表格，并读取了 "Anonymous Feedback" 表格的数据。

2.  **Resources (资源读取)**
    * 代码中使用 `@mcp.resource` 装饰器定义资源。
    * **优势**：允许 AI 直接以只读方式获取大量上下文数据，而无需频繁调用工具。

3.  **Prompts (内置提示词)**
    * 代码中使用 `@mcp.prompt` 定义模板。
    * **演示**：使用了名为 `analyze_sheet_data` 的 Prompt 模板。
    * **效果**：用户只需选择该模板，AI 自动读取表格数据，并生成了一个包含 NPS 分数、定性反馈分析的详细 Dashboard 报告。

### 代码实现逻辑
* 使用 MCP SDK（如 Python SDK）。
* 通过**装饰器 (Decorators)** 标记函数：
    * `@mcp.tool`: 定义工具。
    * `@mcp.resource`: 定义资源 URI 模式。
    * `@mcp.prompt`: 定义提示词模板。
* 这种方式让开发者可以将复杂的业务逻辑封装在 Server 端，而 Host 端（用户）只需“傻瓜式”调用。

---

**总结**：MCP 通过标准化的协议，彻底改变了 AI 连接世界的方式。无论是通过 n8n 快速搭建原型，还是通过代码构建功能强大的企业级 Server，MCP 都为构建上下文丰富的 AI 应用提供了无限可能。